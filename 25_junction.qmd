# Junction {.unnumbered}

```{r set}
#| include: false
library(tidyverse)
```

Correcting typos in vernacular codes and tree ID (
See the following issues to understand the rationale for these corrections: https://github.com/sylvainschmitt/fefaccion_2025/issues/3#issue-3474388377 and https://github.com/sylvainschmitt/fefaccion_2025/issues/2#issue-3470699745)

```{r load_correct_func}
load_correct <- function(my_file) {
  data <- read_tsv(my_file)
  data <- data %>% mutate(
    vernacular = case_match(vernacular,
                            "CUPUI" ~ "CUPIU",
                            .default = vernacular),
    tree = case_match(tree,
                      8833 ~ 8883,
                      8383 ~ 8883,
                      6616 ~ 6617,
                      7734 ~ 7334,
                      .default = tree),
    vernacular = if_else(tree %in% c(5685,6513), "FAVAO", vernacular)
  ) 
  if("comment" %in% colnames(data)) {
    data <-  data %>% select(-comment)
  }
  data
}
```

```{r}
tlp <- load_correct("data/derived/tlp_raw.tsv")
# la <- load_correct("data/derived/la.tsv") # wait for the file
hydrated <- load_correct("data/derived/hydrated_raw.tsv")
dry <- load_correct("data/derived/dry_raw.tsv")
```


Before joining, check for duplicated leaves in each table

> ORGANISE AND WRITE THIS SECTION

in tlp

```{r}
tlp %>% 
  group_by(vernacular, tree, leaf) %>% 
  count() %>% 
  filter(n>1)
```
in la

```{r}
la %>% 
  group_by(vernacular, tree, leaf) %>% 
  count() %>% 
  filter(n>1)
```

in hydrated

```{r}
hydrated %>% 
  group_by(vernacular, tree, leaf) %>% 
  count() %>% 
  filter(n>1)
```

in dry

```{r}
dry %>% 
  group_by(vernacular, tree, leaf) %>% 
  count() %>% 
  filter(n>1)
```


```{r}
tlp %>% filter(tree == 6910 & leaf %in% c(1,2)) %>%
  distinct() %>% 
  count

hydrated %>% filter(tree == 6910 & leaf %in% c(1,2)) %>%
  distinct() %>% 
  count

dry %>% filter(tree == 6910 & leaf %in% c(1,2)) %>%
  distinct() %>% 
  count
```
> Leaves 1 and 2 of COPAI 6910 are duplicated in tlp, hydrated and dry, but they have just one scan each.

```{r}
tlp %>% filter(tree == 6896 & leaf %in% c(1,2)) %>%
  distinct() %>% 
  count
```
> Leaf 1 of COPAI 6896 is dupliated in tlp only, but there is no leaf 2.


```{r}
symdiff(hydrated$tree, dry$tree)
symdiff(hydrated$tree, tlp$tree)
symdiff(dry$tree, tlp$tree)
#  OK there are the FAVA or FAVAO not possible to do with ptlp
```

```{r}
temp <- plyr::join_all(
  list(tlp, hydrated, dry), 
  type = "full"
)

temp %>% 
  group_by(vernacular, tree, leaf) %>% 
  count() %>% 
  filter(n>1) %>% 
  print(n=Inf)

temp %>% filter(tree == 6910, leaf == 2)
temp %>% filter(tree == 6896, leaf == 1) %>% select(vernacular) %>% distinct

colnames(tlp)
colnames(hydrated)
colnames(dry)

```




> TO CONTINUE FROM HERE


Raw data junction and cross cleaning.

```{r prep}
#| eval: false
plyr::join_all(
  list(
    read_tsv("data/derived/tlp_raw.tsv"),
    read_tsv("data/derived/la.tsv"),
    read_tsv("data/derived/hydrated_raw.tsv"),
    read_tsv("data/derived/dry_raw.tsv")
  ),
  type = "full"
) %>% select(-comment) %>% 
  write_tsv("outputs/raw.tsv")
read_tsv("outputs/raw.tsv") %>% 
  mutate(
    la = area_excluded,
    ldmc = dw/sw,
    sla = area_included/dw
  ) %>% 
  select(vernacular, tree, leaf, la, ldmc, lt, lt, sla, tlp) %>% 
  write_tsv("outputs/traits.tsv")
```

```{r figure}
#| message: false
#| warning: false
read_tsv("outputs/traits.tsv") %>% 
  gather(trait, value, -vernacular, -tree, -leaf) %>% 
  mutate(trait = recode(trait, 
                        "la" = "LA [ cm2 ]",
                        "ldmc" = "LDMC [ g / g ]",
                        "lt" = "LT [ µm ]",
                        "tlp" = "TLP [ MPa ]",
                        "sla" = "SLA [ cm2 / g ]")) %>% 
  ggplot(aes(vernacular,
             value)) +
  geom_boxplot() +
  geom_jitter(aes(col = as.factor(tree)),
              width = 0.2, size = 3) + 
  theme_bw() +
  coord_flip() +
  facet_wrap(~ trait, scales = "free_x", ncol = 5) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none") +
  xlab("") + ylab("")
```

> We have outliers LDMC and SLA probably due to an issue with dry weight DW. Other outliers have to be checked.

```{r figure2}
#| message: false
#| warning: false
#| fig-width: 10
#| fig-height: 10
read_tsv("outputs/traits.tsv") %>% 
  filter(sla < 400) %>% 
  select(sla, tlp, vernacular, tree, leaf) %>% 
  na.omit() %>% 
  ggplot(aes(sla, tlp, col = as.character(tree))) +
  geom_smooth(aes(group = vernacular), method = "lm", 
              col = "grey", alpha = .2) +
  geom_point() +
  theme_bw() +
  xlab(expression("SLA ["~cm^{2}~g^{-1}~"]")) +
  ylab(expression("TLP ["~MPa~"]")) +
  facet_wrap(~ vernacular, scales = "free") +
  scale_color_discrete(guide = "none")
```

> Ask back Joannès the link between SLA and TLP to check.

However, based on that I have made an example of data junction in a consolidated table here: <https://docs.google.com/spreadsheets/d/1SSDmBBYNl_jP3GY5wUGkR-62cNiz63M46Ai6Z0CK1Cw/edit?usp=sharing>.

> I also need the cleaned taxonomy I think.
