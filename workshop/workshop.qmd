---
title: "Dinâmica florestal com R"
author: Géraldine Derroire & Sylvain Schmitt
institute: Cirad
date: "11 de julho de 2025"
format: 
  revealjs:
    theme: night
    output-location: fragment 
    slide-number: true
    preview-links: true
    chalkboard: true
    link-external-icon: true
    link-external-newwindow: true
    incremental: false
    smaller: true
execute:
  echo: true   
  warning: false
  message: false
  cache: true
editor: 
  markdown: 
    wrap: sentence
---

<!-- TO DO, put the logos on the title page-->

<!-- Translate the code comments -->

<!-- @Sylvain: pour l'instant, je mets la structure en français, on changera en avançant -->

<!-- TO DO: ajouter les packages à installer dans le doc d'installation -->

```{r}
library(tidyverse)
library(GGally)
library(vegan)
```

# Dados

## Dados de parcelas florestais permanentes

::: {.column width="60%"}
* Dados de uma parcela permanente (parcela 6) na estação de pesquisa florestal de [Paracou](https://paracou.cirad.fr/website) na Guiana Francesa

* Todas as árvores com um diâmetro à altura do peito (DAP) ≥ 10 cm são mapeadas, identificadas botanicamente e medidas em cada censo

![](foto_inventorio.png){fig-align="center" height="60%"}
:::

::: {.column width="5%"}
:::

::: {.column width="35%"}
![](paracou.png)


:::

## Dados de parcelas florestais permanentes

```{r}
#| eval: false
#| echo: false
dt_P6 <- read_csv(file = "data/2024-08-29_ParacouP6AllYears.csv")
dt_P6 <- dt_P6 %>% 
  select(Forest, Plot, PlotArea, SubPlot, 
         idTree, Xutm, Yutm, 
         Family, Genus, Species,
         CensusYear, CodeAlive, CircCorr)

save(dt_P6, file = "data/data_paracou_p6.RData")
```

```{r}
load(file = "data/data_paracou_p6.RData")
dt_P6
```

[⚠️ Esses dados NÃO são de acesso livre, por favor, não os distribua nem utilize para qualquer outro fim.]{.fragment}


## Dados de parcelas florestais permanentes

Esses dados contêm:

::: {.column width="50%"}

- **Forest**: Nome da floresta

- **Plot**: Número da parcela

- **PlotArea**: Área da parcela (hectares)

- **SubPlot**: Número da subparcela

- **idTree**: Identificador único da árvore no banco de dados

- **Xutm** e **Yutm**: Coordenadas da árvore (UTM 22N (EPSG: 32 622))

:::

::: {.column width="50%"}

- **Family**

- **Genus**

- **Species**

- **CensusYear**: Ano da medição

- **CodeAlive**: A árvore está viva (1) ou morta (0)?

- **CircCorr**: Circunferência (cm) da árvore no ponto de medição

:::

## Dados de características funcionais

<!-- @Sylvain: confirme que les données de traits viennet de TRY-->

Vamos usar os dados das características funcionais das árvores da Guiana Francesa obtidos na base de dados [TRY](https://www.try-db.org/TryWeb/Home.php) e compilados no pacote [rcontroll](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.14215).

Esses dados estão disponíveis [aqui](https://github.com/sylvainschmitt/fefaccion_2025/workshop/data/data/dt_traits.RData).

```{r}
#| eval: false
#| echo: false
library(rcontroll)
dt_traits <- TROLLv3_species
dt_traits <- dt_traits %>% rename(species = s_name, 
                                  LMA = s_LMA,
                                  Nmass = s_Nmass, 
                                  Pmass = s_Pmass, 
                                  wsg = s_wsg, 
                                  dbhmax = s_dbhmax, 
                                  hmax = s_hmax, 
                                  ah = s_ah,
                                  regionalfreq = s_regionalfreq, 
                                  tlp = s_tlp, 
                                  drymass = s_drymass, 
                                  seedmass = s_seedmass)
save(dt_traits, file = "data/dt_traits.RData")
```

```{r}
load(file = "data/dt_traits.RData")
dt_traits
```

## Dados de características funcionais

<!-- @Sylvain: unités OK?-->

::: {.column width="50%"}
[Esses dados contêm os valores de 11 características funcionais para 45 espécies. Vamos focar nos seguintes características:]{style="font-size: 25px"}

-   [massa foliar por área (**LMA**, em $kg/m^2$)]{style="font-size: 25px"}

-   [massa de nitrogênio foliar (**Nmass**, em $mg/g$)]{style="font-size: 25px"}

-   [massa de fósforo foliar (**Pmass**, em $mg/g$)]{style="font-size: 25px"}

-   [gravidade específica da madeira (**wsg**, em $g/cm^3$)]{style="font-size: 25px"}

<!-- * [altura máxima da espécie] (**hmax**, em $m$)]{style="font-size: 25px"}-->

-   [potencial hídrico foliar no ponto de perda de turgor (**tlp**, em $MPa$)]{style="font-size: 25px"}

<!--* massa seca foliar (*s_drymass*, em $g$)-->
:::

::: {.column width="50%"}
```{r}
dt_traits <- dt_traits %>% 
  select(species, LMA, Nmass, Pmass, wsg, tlp)

dt_traits %>% slice_head(n = 5)
```
:::

# Exploração de dados de características funcionais

## Distribuição das valores das características

```{r}
#| fig-height: 4
#| fig-width: 8
#| fig-align: center
dt_traits %>% 
  pivot_longer(LMA : tlp, 
               names_to = "traits", values_to = "values") %>% 
  ggplot(aes(x = values, colour = traits)) + geom_density() +
  facet_wrap(~ traits, scales = "free") + theme_bw()
```

::: notes
LMA, Nmass, e Pmass tendem a valores pequenos

hmax a valores grandes
:::

## Coeficientes de variação das características

```{r}
dt_traits %>% summarise(
  across(LMA : tlp,
         function(v) {round(sd(v)/abs(mean(v)), 3)}))
```

## Correlações entre pares de características

```{r}
ggpairs(dt_traits, columns = names(dt_traits)[-1])
```

::: notes
LMA, Nmass e Pmass correlacionados

wsg tlp correlacionados
:::

## Axes de covariância de características funcionais

Análise de componentes principais

```{r}
trait_pca <- dt_traits %>% select(-species) %>% 
  pca(scale = TRUE)
summary(trait_pca)
```

::: notes
os dois primeiros eixos capturam XXX % da variabilidade total do conjunto de dados
:::

## Axes de covariância de características funcionais

```{=html}
<!-- @Sylvain, je suis embeter pour l'interpretation de l'axe 2, je trouve ca surprenant qu'il oppose wsg et tlp...
dans la literature tlp est loin aligné sur le LES (cf papier Joannès), soit sur un autre axe que le LES et wsg (thèse de Daniela par ex...)
Est-ce que tu vois mieux à proposer que mon interpretation?
-->
```

::: {.column width="50%"}
```{r}
#| fig-height: 5
#| fig-width: 6
#| fig-align: center
# display as características
biplot(trait_pca, scaling = 2, 
       display = "species") 
# display as espécies
points(trait_pca, scaling = 2, 
       display = "sites", type ="points") 
```
:::

:::: {.column width="50%"}
::: incremental
-   Axe 1: **espectro econômico das folhas**: estratégias de aquisição de recursos conservadoras (lentas) *versus* aquisitivas (rápidas) [Wright *et al* 2004](https://www.nature.com/articles/nature02403)

- As características da madeira [Baraloto *et al* 2010](https://onlinelibrary.wiley.com/doi/10.1111/j.1461-0248.2010.01517.x) e as características relacionadas com a água [Maréchaux *et al* 2019](https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/1365-2745.13321) são independentes do espectro econômico das folhas.
:::
::::

::: notes
display não é intuitiva no vegan, se não estiver trabalhando com uma tabela florística

"species" são as variáveis (aqui, as características)

"sites" são as observações (aqui, as espécies)
:::

# Exploração dos dados de crescimento

## Preparação dos dados

* Manter apenas as árvores totalmente determinadas

```{r}
dt_P6 <- dt_P6 %>% 
  filter(Species != "Indet.")
```

* Calcular o DAP

```{r}
dt_P6 <- dt_P6 %>% 
  mutate(DBH = CircCorr / pi)
```

* Manter apenas a observação de árvores vivas com $DAP ≥ 10 cm$

```{r}
dt_P6 <- dt_P6 %>% 
  filter(DBH >= 10 & CodeAlive ==1) 
```

* Adicionar os nomes completos das espécies

```{r}
dt_P6 <- dt_P6 %>% 
  unite(GenSp,
        Genus, Species,
        sep = "_", 
        remove = FALSE)
```


## Número de indivíduos

* Número total de indivíduos

```{r}
n_distinct(dt_P6$idTree)
```

::: fragment

* Número de indivíduos por censo e duração do monitoramento 

```{r}
#| fig-height: 3
#| fig-width: 5
#| fig-align: center
dt_P6 %>% count(CensusYear)  %>% 
  ggplot(aes(x = CensusYear, y = n)) + 
  geom_point() + geom_line() + 
  ylim(0, 4000) +
  labs(x = "Ano da medição", y = "Número de indivíduos") +
  theme_bw()
```

:::

::: notes
35 censos entre 1984 e 2024

cerca de 3600-3800 indivíduos por censo 
:::


## Cálculo do crescimento anual

* Obter os anos do censo e os anos dos censos anteriores

```{r}
dt_years <- dt_P6  %>% 
  distinct(CensusYear) %>%
  arrange(CensusYear) %>%
  mutate(PrevYear = c(NA, CensusYear[-length(CensusYear)]))

head(dt_years, n = 5)
```

::: notes
2 etapas
:::

## Cálculo do crescimento anual

* Cálcular o crescimento anual

```{r}
dt_P6 <- dt_P6 %>%
  merge(dt_years, by = "CensusYear", all.x = TRUE) %>% # add the previous year
  group_by(idTree) %>% # group by individual tree
  arrange(CensusYear, .by_group = TRUE) %>% # order the years chronologically
  mutate(
    Growth = c(NA, diff(DBH)) / (CensusYear - PrevYear), # calculate annual growth
  ) %>%
  ungroup()

dt_P6 %>% select(idTree, CensusYear, PrevYear, DBH, Growth) %>% 
  head(n = 15)
```

## Trajetórias de crescimento

<!-- TO DO
choisir des individus contrastés pour les espèces qu'on va modéliser

mais ca va être tendu pour trouver des individus avec une belle courbe de croissance donc ne montrer que les trajectoires de diamètres?
-->

```{r}
plot_traj_DBH <- function(id, dt) {
  # Get species  for title
    sp <- dt %>% filter(idTree == id) %>% distinct(GenSp)
  # nb of measurment  
    n <- dt %>% filter(idTree == id) %>% count() 
  # Plot
    p <- dt %>% 
      filter(idTree == id) %>% 
      ggplot(aes(x=CensusYear, y = DBH)) + 
      geom_point() + 
      geom_smooth(method = "loess", se = FALSE) + 
      labs(x = "Ano da medição",
           y = "Diâmetro à altura do peito (em cm)",
           title = "Trajetória do diâmetro",
           subtitle = paste("Indivíduo ", id, " - ", sp, " (", n, " medições)", 
                            sep = "")) + 
        theme_bw() 
  return(p)
}
```

```{r}

plot_traj_DBH(id = "102557", dt = dt_P6)
```

```{r}
plot_traj_Growth <- function(id, dt) {
  # Get species  for title
    sp <- dt %>% filter(idTree == id) %>% distinct(GenSp)
  # nb of measurment  
    n <- dt %>% filter(idTree == id) %>% count() 
  # Plot
    p <- dt %>% 
      filter(idTree == id) %>% 
      ggplot(aes(x=DBH, y = Growth)) + 
      geom_point() + 
      geom_smooth(method = "loess", se = FALSE) + 
      labs(x = "DBH",
           y = "Crescimento anual (em cm/ano)",
           title = "Trajetória do crescimento",
           subtitle = paste("Indivíduo ", id, " - ", sp, " (", n, " medições)", 
                            sep = "")) + 
        theme_bw() 
  return(p)
}
```

```{r}

plot_traj_Growth(id = "102557", dt = dt_P6)
```


# Modeliser la croissance

!! en fonction de ce qu'on fait pour le paramètre individuel, il faudra peut-être faire un subset des individus avec assez de census (a rajouter dans prep de données)

modèle de Canham avec brms avec (à tester) paramètres à l'espèce + 1 effet indiv aléatoire additif?

avec brms

sur environ 3 espcèes contrastées et si possible présente à Tapajos

# les trais pour expliquer gmax

repartir des gmax de Ecology Letters et faire un lm en frequentiste =\> cf exam Géraldine
